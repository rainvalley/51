C51 COMPILER V9.60.0.0   MAIN                                                              02/25/2020 19:33:38 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\main
                    -.lst) OBJECT(.\Objects\main.obj)

line level    source

   1          #include<stc15f2k60s2.h>
   2          #include<iic.h>
   3          typedef unsigned int uint;
   4          typedef unsigned char uchar;
   5          sbit S7=P3^0;
   6          sbit S6=P3^1;
   7          sbit S5=P3^2;
   8          sbit S4=P3^3;
   9          uchar code SMG[]={0xc0,0xf9,0xa4,0xb0,0x99,0x92,0x82,0xf8,0x80,0x90,0xc1,0x8e};
  10          uchar code SMG_Dot[]={0x40,0x79,0x24,0x30,0x19,0x12,0x02,0x78,0x00,0x10};//有点的段码等于原短码最高位变为0
             -，减去8。
  11          
  12          uint count_f=0;
  13          uchar count_t=0;
  14          uint dat_f=0;
  15          uint dat_v=0;
  16          uint dat_rb2=0;
  17          
  18          bit F_DIS=0;
  19          bit F_VOL=0;
  20          bit F_SMG=0;
  21          bit F_LED=0;
  22          bit F_DAC=0;
  23          
  24          void delay(uint t)
  25          {
  26   1              while(t--);
  27   1      }
  28          
  29          void select(uchar channel)
  30          {
  31   1              switch(channel)
  32   1              {
  33   2                      case 4: P2=(P2&0X1F)|0X80;break;
  34   2                      case 5: P2=(P2&0X1F)|0XA0;break;
  35   2                      case 6: P2=(P2&0X1F)|0XC0;break;
  36   2                      case 7: P2=(P2&0X1F)|0XE0;break;
  37   2                      case 0: P2=P2&0X1F;break;
  38   2              }
  39   1      }
  40          
  41          void display_bit(uchar pos,uchar num)
  42          {
  43   1              P0=0XFF;
  44   1              select(6);
  45   1              P0=0X01<<pos;
  46   1              select(7);
  47   1              P0=num;
  48   1      }
  49          
  50          void ADC()
  51          {
  52   1              IIC_Start();
  53   1              IIC_SendByte(0X90);
C51 COMPILER V9.60.0.0   MAIN                                                              02/25/2020 19:33:38 PAGE 2   

  54   1              IIC_WaitAck();
  55   1              IIC_SendByte(0X43);
  56   1              IIC_WaitAck();
  57   1              IIC_Stop();
  58   1              
  59   1              IIC_Start();
  60   1              IIC_SendByte(0X91);
  61   1              IIC_WaitAck();
  62   1              dat_rb2=IIC_RecByte();
  63   1              IIC_SendAck(1);
  64   1              IIC_Stop();
  65   1              
  66   1              dat_v=dat_rb2*2;
  67   1      }
  68          
  69          void DAC(uchar dat)
  70          {
  71   1              IIC_Start();
  72   1              IIC_SendByte(0x90);
  73   1              IIC_WaitAck();
  74   1              IIC_SendByte(0x40);
  75   1              IIC_WaitAck();
  76   1              IIC_SendByte(dat);
  77   1              IIC_SendAck(1);
  78   1              IIC_Stop();
  79   1      }
  80          
  81          void Init_Timer()
  82          {
  83   1              TL0=0XFF;
  84   1              TH0=0XFF;
  85   1              TL1=(65535-50000)/256;
  86   1              TH1=(65535-50000)%256;
  87   1              
  88   1              TMOD=0X16;
  89   1              ET0=1;
  90   1              ET1=1;
  91   1              EA=1;
  92   1              TR0=1;
  93   1              TR1=1;
  94   1      }
  95          
  96          void ser_t0() interrupt 1
  97          {
  98   1              count_f++;
  99   1      }
 100          
 101          void ser_t1() interrupt 3
 102          {
 103   1              count_t++;
 104   1              if(count_t%10==0)
 105   1              {
 106   2                      F_DAC=~F_DAC;
 107   2              }
 108   1              if(count_t==20)
 109   1              {
 110   2                      dat_f=count_f;
 111   2                      count_f=0;
 112   2                      count_t=0;
 113   2              }
 114   1      }
 115          
C51 COMPILER V9.60.0.0   MAIN                                                              02/25/2020 19:33:38 PAGE 3   

 116          void display_u()
 117          {
 118   1              display_bit(0,SMG[10]);
 119   1              delay(500);
 120   1              display_bit(5,SMG_Dot[(dat_v/100)%10]);
 121   1              delay(500);
 122   1              display_bit(6,SMG[(dat_v/10)%10]);
 123   1              delay(500);
 124   1              display_bit(7,SMG[(dat_v)%10]);
 125   1      }
 126          
 127          void display_f()
 128          {
 129   1              display_bit(0,SMG[11]);
 130   1              delay(500);
 131   1              display_bit(3,SMG[dat_f/10000]);
 132   1              delay(500);
 133   1              display_bit(4,SMG[(dat_f/1000)%10]);
 134   1              delay(500);
 135   1              display_bit(5,SMG[(dat_f/100)%10]);
 136   1              delay(500);
 137   1              display_bit(6,SMG[(dat_f/10)%10]);
 138   1              delay(500);
 139   1              display_bit(7,SMG[dat_f%10]);
 140   1      }
 141          
 142          void led_u()
 143          {
 144   1              select(0);
 145   1              if(dat_v<150)
 146   1                      P0|=0X04;
 147   1              else if(dat_v<250)
 148   1                      P0&=~0X04;
 149   1              else if(dat_v<350)
 150   1                      P0|=0X04;
 151   1              else 
 152   1                      P0&=~0X04;
 153   1              select(4);
 154   1      }
 155          
 156          void led_f()
 157          {
 158   1              select(0);
 159   1              if(dat_f<1000)
 160   1                      P0|=0X08;
 161   1              else if(dat_f<5000)
 162   1                      P0&=~0X08;
 163   1              else if(dat_f<10000)
 164   1                      P0|=0X08;
 165   1              else
 166   1                      P0&=~0X08;
 167   1              select(4);
 168   1      }
 169          
 170          void led()
 171          {
 172   1              select(0);
 173   1              if(F_LED==0)
 174   1              {
 175   2                      if(F_DIS==0)
 176   2                      {
 177   3                              P0=0XFE;
C51 COMPILER V9.60.0.0   MAIN                                                              02/25/2020 19:33:38 PAGE 4   

 178   3                              led_u();
 179   3                      }
 180   2                      else
 181   2                      {
 182   3                              P0=0XFD;
 183   3                              led_f();
 184   3                      }
 185   2                      
 186   2                      if(F_VOL==0)
 187   2                              P0|=0X10;
 188   2                      else
 189   2                              P0&=~0X10;
 190   2              }
 191   1              else
 192   1                      P0=0XFF;
 193   1              select(4);
 194   1      }
 195          
 196          void display()
 197          {
 198   1              if(F_SMG==0)
 199   1              {
 200   2                      if(F_DIS==0)
 201   2                              display_u();
 202   2                      else
 203   2                              display_f();
 204   2              }
 205   1              else
 206   1              {
 207   2                      select(6);
 208   2                      P0=0XFF;
 209   2                      select(7);
 210   2                      P0=0XFF;
 211   2              }
 212   1              led();
 213   1              select(0);
 214   1      }
 215          
 216          void scan()
 217          {
 218   1              if(S4==0)
 219   1              {
 220   2                      delay(100);
 221   2                      if(S4==0)
 222   2                      {
 223   3                              F_DIS=~F_DIS;
 224   3                              while(S4==0)
 225   3                                      display();
 226   3                      }
 227   2              }
 228   1              if(S5==0)
 229   1              {
 230   2                      delay(100);
 231   2                      if(S5==0)
 232   2                      {
 233   3                              F_VOL=~F_VOL;
 234   3                              while(S5==0)
 235   3                                      display();
 236   3                      }
 237   2              }
 238   1              if(S6==0)
 239   1              {
C51 COMPILER V9.60.0.0   MAIN                                                              02/25/2020 19:33:38 PAGE 5   

 240   2                      delay(100);
 241   2                      if(S6==0)
 242   2                      {
 243   3                              F_LED=~F_LED;
 244   3                              while(S6==0)
 245   3                                      display();
 246   3                      }
 247   2              }
 248   1              if(S7==0)
 249   1              {
 250   2                      delay(100);
 251   2                      if(S7==0)
 252   2                      {
 253   3                              F_SMG=~F_SMG;
 254   3                              while(S7==0)
 255   3                                      display();
 256   3                      }
 257   2              }
 258   1      }
 259          
 260          void initsys()
 261          {
 262   1              select(5);
 263   1              P0=0X00;
 264   1              select(4);
 265   1              P0=0XFF;
 266   1              select(0);
 267   1              Init_Timer();
 268   1      }
 269          
 270          
 271          
 272          int main()
 273          {
 274   1              initsys();
 275   1              while(1)
 276   1              {
 277   2                      scan();
 278   2                      if(F_DAC==0)
 279   2                      {
 280   3                              ADC();
 281   3                      }
 282   2                      else
 283   2                      {
 284   3                              if(F_VOL==0)
 285   3                              {
 286   4                                      DAC(102);
 287   4                              }
 288   3                              else
 289   3                              {
 290   4                                      DAC(dat_rb2);
 291   4                              }
 292   3                      }
 293   2                      display();
 294   2              }
 295   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    886    ----
   CONSTANT SIZE    =     22    ----
   XDATA SIZE       =   ----    ----
C51 COMPILER V9.60.0.0   MAIN                                                              02/25/2020 19:33:38 PAGE 6   

   PDATA SIZE       =   ----    ----
   DATA SIZE        =      9       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      5    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
