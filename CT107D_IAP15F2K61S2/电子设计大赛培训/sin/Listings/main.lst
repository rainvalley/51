C51 COMPILER V9.60.0.0   MAIN                                                              07/26/2020 21:32:26 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\main
                    -.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          /*
   2          2020-07-24 22:30
   3          Analyzed by LogicAnalyzer
   4          CT107D_IAP15F2K61S2
   5          IRC Freq:12MHz
   6          DAC:PCF8591 Over IIC
   7          S4: Change freq;S5: Chang Range
   8          */
   9          #include<stc15f2k60s2.h>
  10          #include"iic.h"
  11          #include <intrins.h>
  12          #define len 60
  13          typedef unsigned int uint;
  14          typedef unsigned char uchar;
  15          
  16          sbit S4=P3^3;
  17          sbit S5=P3^2;
  18          uchar code sin_tab[len]={
  19            128,141,154,167,180,191,203,213,223,231,238,244,249,253,255,255,255,253,249,245,238,231,223,213,203,192,1
             -80,167,154,141,128,114,101,88,76,64,53,42,33,24,17,11,6,2,0,0,0,2,6,10,16,24,32,41,52,63,75,87,100,114
  20          };
  21          uchar sin_tab_temp[len]={0};
  22          uchar sin_status=1; //按键对应的波类型
  23          float sin_range=1; //按键对应的波幅度
  24          float freq=261.6; //波频率
  25          float range=1.0; //波幅度
  26          uchar flag=0;
  27            
  28          void init_sys()
  29          {
  30   1        P2=(P2&0x1F)|0x80;
  31   1        P0=0xff;  //配置LED灯熄灭
  32   1        P2=(P2&0x1F)|0xA0;  //选择到Y5端口
  33   1        P0=0x00;  //配置蜂鸣器
  34   1      }
  35          
  36          void Timer0Init()   //@12MHz
  37          {
  38   1        float time=1000000.0/(freq*len); //转换为定时累加单元的对应参数
  39   1        AUXR &= 0x7F;   //定时器时钟12T模式
  40   1        TMOD &= 0xF0;   //设置定时器模式
  41   1        TL0 = (65535-(int)time)%256;    //设置定时初值
  42   1        TH0 = (65535-(int)time)/256;    //设置定时初值
  43   1        TF0 = 0;    //清除TF0标志
  44   1        TR0 = 1;    //定时器0开始计时
  45   1        ET0 = 1;
  46   1        EA = 1;
  47   1      }
  48          
  49          void Delay100us()   //@11.0592MHz
  50          {
  51   1        unsigned char i, j;
  52   1      
  53   1        _nop_();
C51 COMPILER V9.60.0.0   MAIN                                                              07/26/2020 21:32:26 PAGE 2   

  54   1        _nop_();
  55   1        i = 2;
  56   1        j = 15;
  57   1        do
  58   1        {
  59   2          while (--j);
  60   2        } while (--i);
  61   1      }
  62          
  63          void DAC_Write(uchar DAT)
  64          {
  65   1          IIC_Start();                  //I2C总线起始地址
  66   1          IIC_SendByte(0x90);       //发送PCF8591地址加读写方向位0（写）
  67   1          IIC_WaitAck();
  68   1        
  69   1          IIC_SendByte(0x40);     //发送控制字节DAC输出使能 
  70   1          IIC_WaitAck();              //检测是否发送成功(应答)
  71   1        
  72   1          IIC_SendByte(DAT);           //发送数字量交由PCF8591转为模拟量AOUT脚输出
  73   1          IIC_WaitAck();
  74   1        
  75   1          IIC_Stop();                   //I2C停止信号
  76   1      }
  77          
  78          void make_sin() //正弦波参数配置，包括频率与幅度
  79          {
  80   1        int i=0;
  81   1        float temp;
  82   1        for(i;i<len;i++)
  83   1        {
  84   2          temp=range*sin_tab[i];
  85   2          sin_tab_temp[i]=(unsigned char)temp;  //强制类型转换，共PCF8591读取
  86   2        }
  87   1        Timer0Init();
  88   1      }
  89          
  90          void ser_timer()interrupt 1 //中断服务函数内DAC输出正弦波
  91          {
  92   1        DAC_Write(sin_tab_temp[flag]);
  93   1        flag++;
  94   1        if(flag==len)
  95   1        {
  96   2          flag=0;
  97   2        }
  98   1      }
  99          
 100          void Scan_Keys()  //键盘扫描，循环配置波类型与幅度（S4修改波类型，S5修改幅度）
 101          {
 102   1        if(S4==0)
 103   1        {
 104   2          Delay100us();
 105   2          if(S4==0)
 106   2          {
 107   3            if(sin_status==7)
 108   3            {
 109   4              sin_status=1;
 110   4            }
 111   3            sin_status++;
 112   3            while(S4==0);
 113   3          }
 114   2        } 
 115   1        
C51 COMPILER V9.60.0.0   MAIN                                                              07/26/2020 21:32:26 PAGE 3   

 116   1        if(S5==0)
 117   1        {
 118   2          Delay100us();
 119   2          if(S5==0)
 120   2          {
 121   3            if(sin_range==1)
 122   3            {
 123   4              sin_range=0.1;
 124   4            }
 125   3            sin_range=sin_range+0.1;
 126   3            while(S4==0);
 127   3          }
 128   2        }
 129   1      }
 130          
 131          void set_para() //根据按键配置波参数
 132          {
 133   1        Scan_Keys();
 134   1        switch(sin_status){
 135   2          case 1:
 136   2            freq=261.6;
 137   2            break;
 138   2          case 2:
 139   2            freq=293.6;
 140   2            break;
 141   2          case 3:
 142   2            freq=329.6;
 143   2            break;
 144   2          case 4:
 145   2            freq=349.2;
 146   2            break;
 147   2          case 5:
 148   2            freq=392;
 149   2            break;
 150   2          case 6:
 151   2            freq=440;
 152   2            break;
 153   2          case 7:
 154   2            freq=493.8;
 155   2            break;
 156   2        }
 157   1        range=sin_range;
 158   1      }
 159          
 160          int main()
 161          {
 162   1        init_sys();
 163   1        while(1)
 164   1        {
 165   2          set_para();
 166   2          make_sin();
 167   2        }
 168   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    605    ----
   CONSTANT SIZE    =     60    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     74      11
   IDATA SIZE       =   ----    ----
C51 COMPILER V9.60.0.0   MAIN                                                              07/26/2020 21:32:26 PAGE 4   

   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
