C51 COMPILER V9.01   MAIN                                                                  01/20/2020 15:09:27 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN main.OBJ
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c BROWSE DEBUG OBJECTEXTEND

line level    source

   1          #include<reg52.h>
   2          #include"onewire.h"
   3          #include"ds1302.h"
   4          #include"data.h"
   5          #include"iic.h"
   6          void Display_Dynamic();
   7          uchar code dig_code[10]={0xc0,0xf9,0xa4,0xb0,0x99,0x92,0x82,0xf8,0x80,0x90};//数码管显示内容
   8          uchar time[7]={0x00,0x00,0x00,0x01,0x01,0x01,0x20};//DS1302初始化内容
   9          uint temp=0;
  10          int data_pcf8591=0;
  11          uint data_at24c02=0;
  12          //延时函数
  13          void Delay(uint t)
  14          {
  15   1              while(t--);
  16   1      }
  17          
  18          //选择138译码器输出端
  19          void selectHC573(uchar channel)
  20          {
  21   1              switch(channel)
  22   1              {
  23   2                      case 4:
  24   2                      P2=(P2&0x1f)|0x80;//不改变P2其他端口电平的情况下改变138译码器输入，由于前移一位故channel*2。
  25   2                      break;
  26   2                      case 5:
  27   2                      P2=(P2&0x1f)|0xa0;
  28   2                      break;
  29   2                      case 6:
  30   2                      P2=(P2&0x1f)|0xc0;
  31   2                      break;
  32   2                      case 7:
  33   2                      P2=(P2&0x1f)|0xe0;
  34   2                      break;
  35   2              }
  36   1      }
  37          
  38          //按位点亮数码管
  39          void DisplaySMG_Bit(uchar value,uchar pos)
  40          {       
  41   1              selectHC573(6);
  42   1              P0=0X01<<pos;//channel选择为6时选择数码管位置
  43   1              selectHC573(7);
  44   1              P0=dig_code[value];//channel选择为7时选择数码管显示内容
  45   1      }
  46          
  47          //获取温度
  48          void tempget()
  49          {
  50   1              uchar low,high;
  51   1              init_ds18b20();
  52   1              Write_DS18B20(0XCC);
  53   1              Write_DS18B20(0X44);
  54   1      
  55   1              init_ds18b20();
C51 COMPILER V9.01   MAIN                                                                  01/20/2020 15:09:27 PAGE 2   

  56   1              Write_DS18B20(0XCC);
  57   1              Write_DS18B20(0Xbe);
  58   1      /*
  59   1      DS18B20操作步骤(P11)：
  60   1      1-初始化
  61   1      2-跳过ROM
  62   1      3-转换温度(0x44)/开始读取温度Scratchpad(0xbe)
  63   1      */
  64   1      
  65   1              low=Read_DS18B20();
  66   1              high=Read_DS18B20();
  67   1      
  68   1              temp=high<<4;
  69   1              temp|=(low>>4);//将DS18B20数据转换为十进制并截取整数部分
  70   1      } 
  71          
  72          //动态显示温度
  73          void Display_Dynmaic_temp()
  74          {
  75   1              tempget();
  76   1              DisplaySMG_Bit(temp%100/10,5);
  77   1              Delay(500);
  78   1              P0=0XFF;
  79   1              DisplaySMG_Bit(temp%10,6);
  80   1              Delay(500);
  81   1              P0=0XFF;
  82   1              //显示温度整数部分
  83   1              selectHC573(6);
  84   1              P0=0X01<<7;
  85   1              selectHC573(7);
  86   1              P0=0XC6;//显示C代表摄氏度
  87   1      }
  88                                                                                    
  89          //DS1302初始化
  90          
  91          void ds1302_init()
  92          {
  93   1              uchar add=0x80;//写数据地址
  94   1              uchar i;
  95   1              Write_Ds1302_Byte(0x8e,0x00); //关闭写保护
  96   1              for(i=0;i<7;i++)
  97   1              {
  98   2                      Write_Ds1302_Byte(add,time[i]);
  99   2                      add=add+2;
 100   2              }
 101   1              Write_Ds1302_Byte(0x8e,0x80); //开启写保护
 102   1      }
 103          
 104          //读取DS1302时间，地址可见P9，WP位为写保护控制位
 105          void ds1302_read()
 106          {
 107   1              uchar i;
 108   1              uchar add=0x81;//读数据地址
 109   1              Write_Ds1302_Byte(0x8e,0x00);//关闭写保护
 110   1              for(i=0;i<7;i++)
 111   1              {
 112   2                      time[i]=Read_Ds1302_Byte(add);
 113   2                      add=add+2;
 114   2              }
 115   1              Write_Ds1302_Byte(0x8e,0x80);//开启写保护
 116   1      }
 117          
C51 COMPILER V9.01   MAIN                                                                  01/20/2020 15:09:27 PAGE 3   

 118          //动态显示时间
 119          void Display_Dynmaic_time()
 120          {
 121   1              ds1302_read();
 122   1              DisplaySMG_Bit(time[1]/16,0); //BCD码取十位
 123   1              Delay(500);
 124   1              P0=0XFF;
 125   1              DisplaySMG_Bit(time[1]&0x0f,1);//BCD码取个位
 126   1              Delay(500);
 127   1              P0=0XFF; //以上是分钟的显示
 128   1              selectHC573(6);
 129   1              P0=0X01<<2;
 130   1              selectHC573(7);
 131   1              P0=~0X40;
 132   1              Delay(500);
 133   1              P0=0XFF; //以上是分隔符显示
 134   1              DisplaySMG_Bit(time[0]/16,3);
 135   1              Delay(500);
 136   1              P0=0XFF;
 137   1              DisplaySMG_Bit(time[0]&0x0f,4); //以上是秒的显示
 138   1      }
 139          
 140          //从A/D通道3读取数据
 141          void Read_AIN3()
 142          {
 143   1              IIC_Start();            //IIC总线起始信号                                                       
 144   1              IIC_SendByte(0x90);     //PCF8591的写设备地址           
 145   1              IIC_WaitAck();          //等待从机应答
 146   1                              
 147   1              IIC_SendByte(0x03);     //写入PCF8591的控制字节         
 148   1              IIC_WaitAck();          //等待从机应答                                          
 149   1              IIC_Stop();             //IIC总线停止信号                                       
 150   1              
 151   1      
 152   1      
 153   1              IIC_Start();                                                                                    
 154   1              IIC_SendByte(0x91);             
 155   1              IIC_WaitAck();
 156   1                                              
 157   1              data_pcf8591 = IIC_RecByte();                   
 158   1              IIC_SendAck(0);                 //产生非应答信号                                
 159   1              IIC_Stop();             //IIC总线停止信号                                       
 160   1      }
 161          
 162          
 163          void Display_Dynmaic_pcf8591()
 164          {
 165   1              Read_AIN3();
 166   1              DisplaySMG_Bit(data_pcf8591/100,0);
 167   1              Delay(500);
 168   1              P0=0XFF;
 169   1              DisplaySMG_Bit((data_pcf8591%100)/10,1);
 170   1              Delay(500);
 171   1              P0=0XFF;
 172   1              DisplaySMG_Bit(data_pcf8591%10,2);
 173   1              Delay(500);
 174   1      }
 175          
 176          void write_at24c02(uchar addr,uint data_at24c02)
 177          {
 178   1              IIC_Start();
 179   1              IIC_SendByte(0XA0);
C51 COMPILER V9.01   MAIN                                                                  01/20/2020 15:09:27 PAGE 4   

 180   1              IIC_WaitAck();
 181   1              IIC_SendByte(addr);
 182   1              IIC_WaitAck();
 183   1              IIC_SendByte(data_at24c02);
 184   1              IIC_WaitAck();
 185   1              IIC_Stop();
 186   1      }
 187          
 188          uint read_at24c02(uchar addr)
 189          {
 190   1              uchar tmp_at24c02;
 191   1              IIC_Start();
 192   1              IIC_SendByte(0XA0);
 193   1              IIC_WaitAck();
 194   1              IIC_SendByte(addr);
 195   1              IIC_WaitAck();
 196   1      
 197   1              IIC_Start();
 198   1              IIC_SendByte(0XA1);
 199   1              IIC_WaitAck();
 200   1              tmp_at24c02=IIC_RecByte();
 201   1              IIC_SendAck(0);
 202   1              IIC_Stop();
 203   1              return tmp_at24c02;
 204   1      }
 205          
 206          void Display_Dynmaic_at24c02()
 207          {       
 208   1              write_at24c02(0X01,0x0f);
 209   1              data_at24c02=read_at24c02(0x01);
 210   1              DisplaySMG_Bit(data_at24c02/100,0);
 211   1              Delay(500);
 212   1              DisplaySMG_Bit(data_at24c02%100/10,1);
 213   1              Delay(500);
 214   1              DisplaySMG_Bit(data_at24c02%10,2);
 215   1              Delay(500);
 216   1              
 217   1      }
 218          
 219          int main()
 220          {
 221   1              selectHC573(5);
 222   1              P0=0X00;//初始化板上资源，关闭蜂鸣器与继电器
 223   1              ds1302_init();
 224   1      
 225   1              //write_at24c02(0X01,88);
 226   1              //data_at24c02=read_at24c02(0x01);
 227   1      
 228   1              while(1)
 229   1              {       
 230   2                      Display_Dynmaic_temp();
 231   2                      //Display_Dynmaic_time();
 232   2                      //Display_Dynmaic_pcf8591();
 233   2                      Display_Dynmaic_at24c02();
 234   2              }
 235   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    704    ----
   CONSTANT SIZE    =     10    ----
   XDATA SIZE       =   ----    ----
C51 COMPILER V9.01   MAIN                                                                  01/20/2020 15:09:27 PAGE 5   

   PDATA SIZE       =   ----    ----
   DATA SIZE        =     13      10
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
